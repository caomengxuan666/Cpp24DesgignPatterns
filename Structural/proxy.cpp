// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
// â”ƒ  MODULE   ::  Proxy Pattern                                                 â”ƒ
// â”ƒ  PURPOSE   ::  Provide a surrogate to control access to an object           â”ƒ
// â”ƒ  CATEGORY  ::  Behavioral Pattern                                           â”ƒ
// â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

/**
 * @file    proxy.cpp
 * @brief   ç°ä»£ C++20 å®ç°ä»£ç†æ¨¡å¼
 * @details 
 *          ä»£ç†æ¨¡å¼ï¼ˆProxy Patternï¼‰æ˜¯ä¸€ç§è¡Œä¸ºå‹è®¾è®¡æ¨¡å¼ï¼Œä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚
 *          å®ƒå¸¸ç”¨äºå»¶è¿ŸåŠ è½½ã€æƒé™æ§åˆ¶ã€æ—¥å¿—è®°å½•ã€ç¼“å­˜ç­‰åœºæ™¯ã€‚
 * 
 * @par æ ¸å¿ƒæ€æƒ³
 *      - æŠ½è±¡ä¸»é¢˜ï¼ˆSubjectï¼‰å®šä¹‰æ¥å£
 *      - çœŸå®ä¸»é¢˜ï¼ˆRealSubjectï¼‰å®ç°ä¸šåŠ¡é€»è¾‘
 *      - ä»£ç†ï¼ˆProxyï¼‰æŒæœ‰çœŸå®å¯¹è±¡ï¼Œæ§åˆ¶è®¿é—®
 *      - å®¢æˆ·ç«¯é€šè¿‡ä»£ç†è®¿é—®çœŸå®å¯¹è±¡
 * 
 * @note    æœ¬å®ç°ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ + ä¾èµ–æ³¨å…¥ï¼Œé¿å…å†…å­˜æ³„æ¼
 * @warning ä»£ç†åº”è°ƒç”¨çœŸå®å¯¹è±¡ï¼Œè€Œéå®Œå…¨æ›¿ä»£
 * @todo    æ”¯æŒåŠ¨æ€ä»£ç†ï¼ˆè¿è¡Œæ—¶ç”Ÿæˆï¼‰
 * @date    2025-08-19
 * @version 1.0
 */

#include <memory>
#include <print>
#include <string>

using std::println;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æŠ½è±¡ä¸»é¢˜ï¼šSubject â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * @brief æŠ½è±¡ä¸»é¢˜ï¼šè´­ç¥¨æ¥å£
 */
class Subject {
public:
    virtual ~Subject() = default;
    virtual void purchaseTicket() = 0;
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ çœŸå®ä¸»é¢˜ï¼šUser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * @brief çœŸå®ç”¨æˆ·ï¼šæ‰§è¡Œå®é™…è´­ç¥¨é€»è¾‘
 */
class User : public Subject {
public:
    void purchaseTicket() override {
        println("ğŸ« ç”¨æˆ·ä¹°ç¥¨ï¼šé€‰æ‹©åº§ä½ã€æ”¯ä»˜ã€å‡ºç¥¨");
    }
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä»£ç†åŸºç±»ï¼ˆå¯é€‰ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * @brief ä»£ç†åŸºç±»ï¼ˆå¯é€‰ï¼Œç”¨äºç»Ÿä¸€æ¥å£ï¼‰
 */
class ProxyBase : public Subject {
protected:
    std::unique_ptr<Subject> realSubject;

public:
    explicit ProxyBase(std::unique_ptr<Subject> subject)
        : realSubject(std::move(subject)) {}
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å…·ä½“ä»£ç†ï¼šæºç¨‹è´­ç¥¨ä»£ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * @brief æºç¨‹ä»£ç†ï¼šè´­ç¥¨ä¸­ä»‹
 */
class CtripProxy : public ProxyBase {
public:
    using ProxyBase::ProxyBase;

    void purchaseTicket() override {
        println("ğŸ¨ æºç¨‹ä»£ç†ï¼šå¼€å§‹è´­ç¥¨æµç¨‹");
        println("ğŸ” æºç¨‹ä»£ç†ï¼šéªŒè¯ç”¨æˆ·èº«ä»½");
        println("ğŸ’³ æºç¨‹ä»£ç†ï¼šæ·»åŠ ä¿é™©æœåŠ¡ï¼ˆ+20å…ƒï¼‰");

        // âœ… è°ƒç”¨çœŸå®å¯¹è±¡
        if (realSubject) {
            realSubject->purchaseTicket();
        } else {
            println("âŒ æºç¨‹ä»£ç†ï¼šæœªè®¾ç½®çœŸå®å¯¹è±¡");
        }

        println("ğŸ“§ æºç¨‹ä»£ç†ï¼šå‘é€ç”µå­ç¥¨åˆ°é‚®ç®±");
        println("ğŸ“Š æºç¨‹ä»£ç†ï¼šè®°å½•ç”¨æˆ·è¡Œä¸ºæ—¥å¿—");
    }
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å¢å¼ºä»£ç†ï¼šæ—¥å¿— + æƒé™ä»£ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * @brief æ—¥å¿—ä»£ç†ï¼šè®°å½•æ–¹æ³•è°ƒç”¨
 */
class LoggingProxy : public ProxyBase {
public:
    using ProxyBase::ProxyBase;

    void purchaseTicket() override {
        println("ğŸ“ æ—¥å¿—ä»£ç†ï¼šæ–¹æ³• purchaseTicket() è°ƒç”¨å¼€å§‹");
        if (realSubject) {
            realSubject->purchaseTicket();
        }
        println("ğŸ“ æ—¥å¿—ä»£ç†ï¼šæ–¹æ³• purchaseTicket() è°ƒç”¨ç»“æŸ");
    }
};

/**
 * @brief æƒé™ä»£ç†ï¼šæ§åˆ¶è®¿é—®
 */
class AuthProxy : public ProxyBase {
    std::string userRole;

public:
    AuthProxy(std::unique_ptr<Subject> subject, std::string role)
        : ProxyBase(std::move(subject)), userRole(std::move(role)) {}

    void purchaseTicket() override {
        if (userRole == "admin" || userRole == "user") {
            println("ğŸ” æƒé™ä»£ç†ï¼šç”¨æˆ·è§’è‰² '{}' é€šè¿‡éªŒè¯", userRole);
            if (realSubject) {
                realSubject->purchaseTicket();
            }
        } else {
            println("ğŸš« æƒé™ä»£ç†ï¼šç”¨æˆ·è§’è‰² '{}' æ— æƒé™è´­ç¥¨", userRole);
        }
    }
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æµ‹è¯•å‡½æ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * @brief ä½¿ç”¨ä»£ç†è´­ç¥¨
 */
void purchaseWithProxy(Subject &subject) {
    subject.purchaseTicket();
}

/**
 * @brief æµ‹è¯•åŸºæœ¬ä»£ç†
 */
void testBasicProxy() {
    println("\nğŸ§ª æµ‹è¯• 1: åŸºæœ¬ä»£ç†æ¨¡å¼ï¼ˆæºç¨‹ï¼‰");

    auto user = std::make_unique<User>();
    auto ctrip = std::make_unique<CtripProxy>(std::move(user));

    purchaseWithProxy(*ctrip);
}

/**
 * @brief æµ‹è¯•ä»£ç†é“¾ï¼ˆè£…é¥°è€…é£æ ¼ï¼‰
 */
void testProxyChain() {
    println("\nğŸ§ª æµ‹è¯• 2: ä»£ç†é“¾ï¼ˆæ—¥å¿— + æƒé™ + çœŸå®å¯¹è±¡ï¼‰");

    auto user = std::make_unique<User>();
    auto auth = std::make_unique<AuthProxy>(std::move(user), "user");
    auto logging = std::make_unique<LoggingProxy>(std::move(auth));

    purchaseWithProxy(*logging);
}

/**
 * @brief æµ‹è¯•æƒé™æ§åˆ¶
 */
void testAuthControl() {
    println("\nğŸ§ª æµ‹è¯• 3: æƒé™æ§åˆ¶");

    auto user = std::make_unique<User>();

    // æ™®é€šç”¨æˆ·
    auto authUser = std::make_unique<AuthProxy>(std::move(user), "user");
    purchaseWithProxy(*authUser);

    // æ¸¸å®¢
    auto guest = std::make_unique<User>();
    auto authGuest = std::make_unique<AuthProxy>(std::move(guest), "guest");
    purchaseWithProxy(*authGuest);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä¸»å‡½æ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * @brief ä¸»å‡½æ•°
 * @return int
 */
int main() {
    println("ğŸ¯ å¼€å§‹æµ‹è¯•ç°ä»£ C++20 ä»£ç†æ¨¡å¼");

    testBasicProxy();
    testProxyChain();
    testAuthControl();

    println("\nâœ… æ‰€æœ‰æµ‹è¯•å®Œæˆï¼");
    return 0;
}